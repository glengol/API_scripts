<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Snapshot Report - {{ report_date }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .cost-savings {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .orphaned-resources {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .footer {
            background-color: #f8f9fa;
            padding: 2rem 0;
            margin-top: 3rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand">ðŸ“Š AWS Snapshot Report</span>
            <span class="navbar-text">Generated: {{ report_date }}</span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Executive Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-3">Executive Summary</h2>
            </div>
        </div>
        
        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <h3>{{ total_snapshots }}</h3>
                    <p class="mb-0">Total Snapshots</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <h3>${{ "%.2f"|format(total_monthly_cost) }}</h3>
                    <p class="mb-0">Monthly Cost</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card orphaned-resources text-center">
                    <h3>{{ orphaned_count }}</h3>
                    <p class="mb-0">Orphaned Resources</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card cost-savings text-center">
                    <h3>${{ "%.2f"|format(orphaned_monthly_cost) }}</h3>
                    <p class="mb-0">Potential Savings</p>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Snapshot Distribution by Type</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="typeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Cost Distribution by Region</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="regionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Distribution Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Snapshot Distribution by Account (Orphaned vs Parented)</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="accountChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Age Distribution Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Snapshot Age Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="ageChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cost Savings Opportunities -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">ðŸš¨ Cost Savings Opportunities</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">These orphaned snapshots represent potential cost savings:</p>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="savingsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Snapshot ID</th>
                                        <th>Type</th>
                                        <th>Size (GB)</th>
                                        <th>Age (Days)</th>
                                        <th>Monthly Cost</th>
                                        <th>Total Cost</th>
                                        <th>Region</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for snapshot in orphaned_snapshots %}
                                    <tr>
                                        <td><code>{{ snapshot.snapshot_id[:20] }}...</code></td>
                                        <td><span class="badge bg-{{ 'primary' if snapshot.snapshot_type == 'ebs' else 'success' }}">{{ snapshot.snapshot_type.upper() }}</span></td>
                                        <td>{{ snapshot.size_gb }}</td>
                                        <td>{{ snapshot.age_days }}</td>
                                        <td class="text-danger fw-bold">{{ snapshot.monthly_cost }}</td>
                                        <td class="text-danger">{{ snapshot.cost_since_creation }}</td>
                                        <td><span class="badge bg-secondary">{{ snapshot.region }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Data Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Detailed Snapshot Data</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="mainTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Snapshot ID</th>
                                        <th>Type</th>
                                        <th>Creation Date</th>
                                        <th>Size (GB)</th>
                                        <th>Parent Resource</th>
                                        <th>Account</th>
                                        <th>Region</th>
                                        <th>Age (Days)</th>
                                        <th>Monthly Cost</th>
                                        <th>Total Cost</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for snapshot in all_snapshots %}
                                    <tr class="{{ 'table-warning' if snapshot.orphaned else '' }}">
                                        <td><code>{{ snapshot.snapshot_id[:20] }}...</code></td>
                                        <td><span class="badge bg-{{ 'primary' if snapshot.snapshot_type == 'ebs' else 'success' }}">{{ snapshot.snapshot_type.upper() }}</span></td>
                                        <td>{{ snapshot.creation_date[:10] if snapshot.creation_date else 'N/A' }}</td>
                                        <td>{{ snapshot.size_gb }}</td>
                                        <td>
                                            {% if snapshot.orphaned %}
                                                <span class="text-danger">Orphaned</span>
                                            {% else %}
                                                {{ snapshot.parent_resource_type }}: {{ snapshot.parent_resource_id[:20] if snapshot.parent_resource_id else 'N/A' }}...
                                            {% endif %}
                                        </td>
                                        <td>{{ snapshot.account_id }}</td>
                                        <td><span class="badge bg-secondary">{{ snapshot.region }}</span></td>
                                        <td>{{ snapshot.age_days }}</td>
                                        <td class="fw-bold">{{ snapshot.monthly_cost }}</td>
                                        <td>{{ snapshot.cost_since_creation }}</td>
                                        <td>
                                            {% if snapshot.orphaned %}
                                                <span class="badge bg-danger">Orphaned</span>
                                            {% else %}
                                                <span class="badge bg-success">Active</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>Report Information</h6>
                    <p class="mb-0">Generated on: {{ report_date }}</p>
                    <p class="mb-0">Total snapshots analyzed: {{ total_snapshots }}</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <h6>Cost Summary</h6>
                    <p class="mb-0">Total monthly cost: ${{ "%.2f"|format(total_monthly_cost) }}</p>
                    <p class="mb-0">Potential savings: ${{ "%.2f"|format(orphaned_monthly_cost) }}</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        // Initialize DataTables
        $(document).ready(function() {
            $('#mainTable').DataTable({
                pageLength: 25,
                order: [[7, 'desc']], // Sort by age descending
                responsive: true
            });
            
            $('#savingsTable').DataTable({
                pageLength: 10,
                order: [[4, 'desc']], // Sort by monthly cost descending
                responsive: true
            });
        });

        // Chart.js Charts
        const typeData = {{ type_distribution|tojson }};
        const regionData = {{ region_distribution|tojson }};
        const accountData = {{ account_distribution|tojson }};
        const ageData = {{ age_distribution|tojson }};

        // Snapshot Type Distribution Chart
        new Chart(document.getElementById('typeChart'), {
            type: 'doughnut',
            data: {
                labels: typeData.labels,
                datasets: [{
                    data: typeData.data,
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Region Cost Distribution Chart
        new Chart(document.getElementById('regionChart'), {
            type: 'bar',
            data: {
                labels: regionData.labels,
                datasets: [{
                    label: 'Monthly Cost ($)',
                    data: regionData.data,
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });

        // Account Distribution Chart (Grouped: Orphaned, Parented, Total)
        new Chart(document.getElementById('accountChart'), {
            type: 'bar',
            data: {
                labels: accountData.labels,
                datasets: [{
                    label: 'Orphaned Snapshots',
                    data: accountData.orphaned_data,
                    backgroundColor: '#dc3545',
                    borderColor: '#c82333',
                    borderWidth: 1
                }, {
                    label: 'Parented Snapshots',
                    data: accountData.parented_data,
                    backgroundColor: '#28a745',
                    borderColor: '#1e7e34',
                    borderWidth: 1
                }, {
                    label: 'Total Snapshots',
                    data: accountData.total_data,
                    backgroundColor: '#6c757d',
                    borderColor: '#545b62',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: false
                    },
                    y: {
                        beginAtZero: true,
                        stacked: false,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const orphaned = accountData.orphaned_data[context.dataIndex];
                                const parented = accountData.parented_data[context.dataIndex];
                                const total = accountData.total_data[context.dataIndex];
                                
                                if (context.datasetIndex === 0) { // Orphaned
                                    return `Total: ${total} | Parented: ${parented}`;
                                } else if (context.datasetIndex === 1) { // Parented
                                    return `Total: ${total} | Orphaned: ${orphaned}`;
                                } else { // Total
                                    return `Orphaned: ${orphaned} | Parented: ${parented}`;
                                }
                            }
                        }
                    }
                }
            }
        });

        // Age Distribution Chart
        new Chart(document.getElementById('ageChart'), {
            type: 'bar',
            data: {
                labels: ageData.labels,
                datasets: [{
                    label: 'Number of Snapshots',
                    data: ageData.data,
                    backgroundColor: '#28a745'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
</body>
</html>